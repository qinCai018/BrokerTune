# 吞吐量测试

## 概述

本目录包含吞吐量测试脚本，用于测试不同Broker配置和工作负载组合下的吞吐量性能。

## 文档导航

- **[WORKFLOW.md](WORKFLOW.md)** - 详细的工作流程说明（推荐阅读）
- **[QUICK_START.md](QUICK_START.md)** - 快速开始指南
- **README.md** - 本文档（使用说明）

## 测试内容

### Broker配置

1. **max_inflight_100**: `max_inflight_messages=100`，其他参数使用默认值
2. **default**: 所有参数使用默认值

**重要**：在两种Broker配置之间切换时，会**强制重启MQTT Broker**，确保配置完全生效。Broker重启后，工作负载（emqtt_bench）会自动重新启动。

### 工作负载组合（每种配置测试12种）

| 消息大小 | QoS | 发布周期(ms) | 发布端 | 接收端 |
|---------|-----|-------------|--------|--------|
| 256B    | 0   | 10          | 100    | 10     |
| 256B    | 0   | 50          | 100    | 10     |
| 256B    | 1   | 10          | 100    | 10     |
| 256B    | 1   | 50          | 100    | 10     |
| 512B    | 0   | 10          | 100    | 10     |
| 512B    | 0   | 50          | 100    | 10     |
| 512B    | 1   | 10          | 100    | 10     |
| 512B    | 1   | 50          | 100    | 10     |
| 1024B   | 0   | 10          | 100    | 10     |
| 1024B   | 0   | 50          | 100    | 10     |
| 1024B   | 1   | 10          | 100    | 10     |
| 1024B   | 1   | 50          | 100    | 10     |

**总计**: 2种配置 × 12种工作负载 = 24个测试用例

**测试顺序**：
- 先测试所有12种工作负载组合（使用max_inflight_100配置）
- 然后切换到default配置，再测试所有12种工作负载组合
- **配置切换时会强制重启Broker，并重启工作负载**

## 使用方法

### 基本使用

```bash
cd /home/qincai/userDir/BrokerTuner/verify

# 使用运行脚本（推荐）
./run_test.sh

# 或直接运行Python脚本
sudo python3 throughput_test.py
```

**注意**: 输出CSV文件会自动保存在verify目录下（`verify/throughput_test_results.csv`）

### 自定义参数

```bash
# 指定输出文件
sudo python3 throughput_test.py --output my_results.csv

# 自定义稳定运行时间（默认30秒）
sudo python3 throughput_test.py --stable-time 60.0
```

## 测试流程

每个测试用例的执行流程：

1. **应用Broker配置** ⚠️ **重要**
   - 根据配置设置Broker参数
   - **如果切换Broker配置（从max_inflight_100切换到default或反之），会强制重启Broker**
   - 等待Broker稳定（重启或reload）
   - 验证Broker是否正常运行（检查服务状态和端口监听）

2. **重启工作负载** ⚠️ **重要**
   - **确保之前的工作负载已完全停止**（如果存在）
   - 如果Broker已重启，额外等待5秒确保Broker完全就绪
   - 等待进程完全终止（3秒）
   - 启动新的工作负载（指定数量的发布者和订阅者）
   - 使用指定的消息大小、QoS和发布周期
   - **Broker重启后，工作负载会自动重新启动**

3. **稳定运行**
   - 等待30秒（默认）让工作负载稳定运行

4. **统计吞吐量**
   - 通过订阅`$SYS/broker/messages/received`等主题获取消息计数
   - 计算5秒内的消息增量，得到平均每秒消息数（吞吐量）

5. **停止工作负载**
   - 停止所有发布者和订阅者进程
   - 等待进程完全终止（3秒）

6. **记录结果**
   - 将结果保存到CSV文件

**重要说明**：
- 每个测试用例都会完全重启工作负载（停止旧进程，启动新进程），确保测试之间相互独立
- **在两种Broker配置之间切换时，会强制重启Broker**，确保配置完全生效
- **Broker重启后，工作负载会自动重新启动**，保证测试的连续性

## 输出结果

测试结果保存在CSV文件中（位于verify目录下），包含以下列：

### 基本信息
- `broker_config`: Broker配置名称（max_inflight_100 或 default）
- `message_size`: 消息大小（字节）
- `qos`: QoS级别（0或1）
- `publisher_interval_ms`: 发布周期（毫秒）
- `num_publishers`: 发布者数量
- `num_subscribers`: 订阅者数量
- `throughput`: 吞吐量（msg/s，每秒消息数）
- `error`: 错误信息（如果有）

### Broker配置项（每行都包含所有配置项的值）
- `max_inflight_messages`: 每个客户端同时处于飞行状态的QoS 1和QoS 2消息数量上限
- `max_inflight_bytes`: 每个客户端同时处于飞行状态的QoS 1和QoS 2消息总字节数
- `max_queued_messages`: 每个客户端队列中QoS 1和QoS 2消息数量上限
- `max_queued_bytes`: 每个客户端队列中QoS 1和QoS 2消息的总字节数
- `queue_qos0_messages`: 持久化客户端断开连接期间，其QoS 0消息是否加入队列缓存（True/False）
- `memory_limit`: Broker内存使用上限（0表示无限制）
- `persistence`: 是否开启持久化（True/False）
- `autosave_interval`: 持久化启动后，将运行数据写入磁盘的间隔（秒，0表示关闭）
- `set_tcp_nodelay`: 关闭客户端套接字的Nagle算法（True/False）
- `max_packet_size`: Broker能接收的最大MQTT报文长度（0表示无限制）
- `message_size_limit`: Broker允许接收的最大消息负载（0表示无限制）

## 注意事项

1. **需要sudo权限**: 修改Broker配置需要root权限
2. **确保Mosquitto运行**: 测试前确保Mosquitto服务正在运行
3. **确保emqtt_bench可用**: 工作负载需要emqtt_bench工具
4. **测试时间**: 每个测试用例约需45-55秒，全部24个测试约需18-22分钟
   - 每个测试用例包括：停止旧工作负载(3s) + 启动新工作负载 + 稳定运行(30s) + 统计吞吐量(10s) + 停止工作负载(3s)
5. **磁盘空间**: 确保有足够的磁盘空间（测试过程中可能产生日志）
6. **工作负载重启**: 每个测试用例都会完全重启工作负载（停止旧进程，启动新进程），确保测试之间相互独立

## 示例输出

```
================================================================================
开始吞吐量测试
================================================================================

################################################################################
测试进度: 1/24
################################################################################

================================================================================
应用Broker配置: max_inflight_100
================================================================================
  设置 max_inflight_messages = 100
  Broker配置已重载，等待稳定...
  ✅ Broker配置应用完成

================================================================================
测试用例: 256B, QoS=0, 周期=10ms
================================================================================

启动工作负载...
  发布者: 100
  订阅者: 10
  消息大小: 256B
  QoS: 0
  发布周期: 10ms
  ✅ 工作负载启动成功

等待工作负载稳定运行 30.0 秒...

开始统计吞吐量...
  第一次采样（5秒）...
  第二次采样（5秒）...
  使用 $SYS/broker/messages/received: 50000 条消息 / 5秒 = 10000.00 msg/s
  ✅ 吞吐量统计完成: 10000.00 msg/s

停止工作负载...
  ✅ 工作负载已停止

✅ 结果已保存到: throughput_test_results.csv
```

## 故障排除

### 问题1：无法连接到Broker

**检查**:
```bash
# 检查Mosquitto服务状态
systemctl status mosquitto

# 检查端口监听
sudo netstat -tlnp | grep 1883
```

### 问题2：工作负载启动失败

**检查**:
```bash
# 检查emqtt_bench是否可用
which emqtt_bench

# 或设置环境变量
export EMQTT_BENCH_PATH=/path/to/emqtt_bench
```

### 问题3：无法获取吞吐量数据

**可能原因**:
- `$SYS`主题未启用
- Broker配置问题

**解决**:
```bash
# 检查$SYS主题是否可用
mosquitto_sub -h 127.0.0.1 -t '$SYS/#' -v
```

## 相关文档

### 本目录文档
- **[WORKFLOW.md](WORKFLOW.md)** - 详细的工作流程说明（包含完整的流程图和步骤详解）
- **[QUICK_START.md](QUICK_START.md)** - 快速开始指南

### 项目文档
- [训练命令指南](../docs/training/TRAINING_COMMAND.md)
- [工作负载管理](../script/workload.py)
